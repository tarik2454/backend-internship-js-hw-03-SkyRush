import crypto from "crypto";

/**
 * Генерирует случайное число от 0 до 1 на основе Provably Fair алгоритма
 *
 * Provably Fair (Доказуемо честный) - это алгоритм, который позволяет пользователю
 * проверить, что результат был сгенерирован честно, без возможности подтасовки со стороны сервера.
 *
 * Принцип работы:
 * 1. Объединяем serverSeed, clientSeed и nonce в одну строку
 * 2. Создаем HMAC-SHA256 хеш от этой строки (используя саму строку как ключ)
 * 3. Берем первые 8 символов хеша (32 бита в шестнадцатеричном формате)
 * 4. Конвертируем их в десятичное число от 0 до 0xffffffff (4294967295)
 * 5. Делим на максимальное значение, чтобы получить число от 0 до 1
 *
 * Почему это честно:
 * - serverSeed хранится на сервере и может быть раскрыт после игры
 * - clientSeed может быть установлен пользователем
 * - nonce уникален для каждой игры
 * - HMAC - криптографически стойкая функция, невозможно предсказать результат
 * - После игры пользователь может проверить: взять serverSeed, clientSeed, nonce
 *   и убедиться, что rollValue действительно был вычислен из этих данных
 *
 * @param serverSeed - Секретный ключ сервера (32 байта в hex формате)
 * @param clientSeed - Ключ клиента (может быть установлен пользователем)
 * @param nonce - Уникальный номер игры (обычно порядковый номер игры пользователя)
 * @returns Случайное число от 0.0 до 1.0 (включительно)
 *
 * @example
 * const roll = generateRoll(
 *   "abc123...",  // serverSeed
 *   "my_seed",    // clientSeed
 *   5             // nonce (5-я игра пользователя)
 * );
 * // Возвращает, например, 0.723456789
 */
export function generateRoll(
  serverSeed: string,
  clientSeed: string,
  nonce: number
): number {
  // Объединяем все компоненты в одну строку через разделитель ":"
  // Формат: "serverSeed:clientSeed:nonce"
  const combined = `${serverSeed}:${clientSeed}:${nonce}`;

  // Создаем HMAC-SHA256 хеш
  // HMAC (Hash-based Message Authentication Code) - это криптографическая функция,
  // которая создает хеш с использованием секретного ключа
  // В данном случае используем саму строку combined как ключ для HMAC
  const hash = crypto.createHmac("sha256", combined).digest("hex");

  // Берем первые 8 символов хеша (это 32 бита в шестнадцатеричном формате)
  // Например, если hash = "a1b2c3d4e5f6...", то hash.slice(0, 8) = "a1b2c3d4"
  // Конвертируем hex в десятичное число: parseInt("a1b2c3d4", 16)
  // Делим на максимальное 32-битное число (0xffffffff = 4294967295)
  // Это дает нам число от 0.0 до 1.0
  const decimal = parseInt(hash.slice(0, 8), 16) / 0xffffffff;
  return decimal;
}
